name: Build Android APK (Final Fix)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºæ‚¨çš„ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. ã€æ ¸å¿ƒä¿®å¤æ­¥éª¤ã€‘å¼ºåˆ¶ä¿®å¤ç¼ºå¤±çš„æ’ä»¶å’Œæ ¸å¿ƒ
      # è¿™æ¬¡åŠ ä¸Šäº† --recursiveï¼Œç¡®ä¿æ‹‰ä¸‹æ¥çš„ core ä¸æ˜¯ç©ºå£³ï¼
      - name: Fix Missing Plugins & Core (Deep Repair)
        run: |
          echo "ğŸ” Checking integrity..."
          
          # å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥å…‹éš†å®˜æ–¹èµ„æº
          repair_from_official() {
            echo "ğŸš‘ Detected missing files. Cloning official repository (recursively)..."
            # æ³¨æ„ï¼šè¿™é‡ŒåŠ äº† --recursiveï¼Œè¿™æ˜¯è§£å†³ä¸Šæ¬¡æŠ¥é”™çš„å…³é”®
            git clone --recursive --depth 1 https://github.com/chen08209/FlClash.git temp_official_repo
            
            echo "ğŸ“¦ Restoring 'plugins' folder..."
            rm -rf plugins
            cp -r temp_official_repo/plugins .
            
            echo "ğŸ“¦ Restoring 'core' folder..."
            rm -rf core
            cp -r temp_official_repo/core .
            
            echo "ğŸ§¹ Cleaning up temp files..."
            rm -rf temp_official_repo
          }

          # æ£€æŸ¥ core/Clash.Meta æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ ! -d "core/Clash.Meta" ] || [ -z "$(ls -A core/Clash.Meta)" ]; then
            repair_from_official
          elif [ ! -d "plugins/launch_at_startup" ]; then
            repair_from_official
          else
            echo "âœ… Files seem intact."
          fi
          
          # éªŒè¯ä¸€ä¸‹ core é‡Œé¢åˆ°åº•æœ‰æ²¡æœ‰ä¸œè¥¿ (Debug)
          echo "ğŸ“‚ Verifying core structure:"
          ls -F core/
          if [ -d "core/Clash.Meta" ]; then
             echo "âœ… core/Clash.Meta exists."
             ls -F core/Clash.Meta/go.mod || echo "âŒ go.mod missing!"
          else
             echo "âŒ core/Clash.Meta is still missing!"
          fi

      # 3. å®‰è£… Java JDK 17
      - name: Set up Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. å®‰è£… Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 5. å®‰è£… Go è¯­è¨€ (ç¼–è¯‘æ ¸å¿ƒå¿…é¡»)
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: false

      # 6. å®‰è£… Ninja ç¼–è¯‘å·¥å…·
      - name: Install Ninja build tool
        run: sudo apt-get update && sudo apt-get install -y ninja-build

      # 7. å®‰è£… Android SDK å’Œ NDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk-version: 25.2.9519653
          build-tools: 34.0.0

      # 8. å¼ºåˆ¶é…ç½® NDK ç¯å¢ƒå˜é‡
      - name: Install and configure NDK
        run: |
          echo "Configuring NDK..."
          NDK_PATH=$(find $ANDROID_HOME/ndk -maxdepth 1 -type d | sort -V | tail -n 1)
          if [ -z "$NDK_PATH" ]; then
            echo "Downloading NDK manually..."
            wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O /tmp/ndk.zip
            unzip -q /tmp/ndk.zip -d /tmp/
            NDK_PATH="/tmp/android-ndk-r25b"
          fi
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK=$NDK_PATH" >> $GITHUB_ENV

      # 9. è·å–ä¾èµ–
      - name: Get Flutter dependencies
        run: flutter pub get

      # 10. åˆå§‹åŒ–å¹¶ç¼–è¯‘æ ¸å¿ƒ (Goç¼–è¯‘)
      # è¿™æ¬¡ core æ–‡ä»¶å¤¹é‡Œæœ‰ä¸œè¥¿äº†ï¼Œè¿™ä¸€æ­¥å°±ä¸ä¼šæŠ¥é”™äº†
      - name: Build Android Core
        run: dart ./setup.dart android

      # 11. æ„å»º Release APK
      - name: Build Release APK
        id: build
        run: |
          flutter build apk --release --verbose 2>&1 | tee build.log
        continue-on-error: true

      # 12. ä¸Šä¼ æ„å»ºæ—¥å¿— (å¦‚æœå¤±è´¥)
      - name: Upload build log
        if: steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 3

      # 13. æ£€æŸ¥ç»“æœ
      - name: Check build result
        if: steps.build.outcome == 'failure'
        run: |
          echo "Build failed! Logs:"
          tail -n 100 build.log
          exit 1

      # 14. ä¸Šä¼ æˆåŠŸçš„æ–‡ä»¶
      - name: Upload APK
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: flclash-android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
