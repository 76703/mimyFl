name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码（关键：fetch-depth: 0 确保版本号生成正确）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. 安装 Java JDK 17
      - name: Set up Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. 安装 Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 4. 安装 Go 语言 (Core 编译必须)
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: false

      # 5. 安装 Ninja 编译工具
      - name: Install Ninja build tool
        run: sudo apt-get update && sudo apt-get install -y ninja-build

      # 6. 安装 Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk-version: 25.2.9519653 # 指定具体的稳定版本
          build-tools: 34.0.0

      # 7. 强制配置 NDK 环境变量 (双重保险)
      - name: Install and configure NDK
        run: |
          echo "Looking for NDK..."
          # 尝试找到 setup-android 安装的 NDK
          NDK_PATH=$(find $ANDROID_HOME/ndk -maxdepth 1 -type d | sort -V | tail -n 1)
          
          if [ -z "$NDK_PATH" ] || [ "$NDK_PATH" = "$ANDROID_HOME/ndk" ]; then
            echo "NDK not found standardly, downloading manual fallback..."
            wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O /tmp/ndk.zip
            unzip -q /tmp/ndk.zip -d /tmp/
            NDK_PATH="/tmp/android-ndk-r25b"
          fi
          
          echo "Using NDK at: $NDK_PATH"
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK=$NDK_PATH" >> $GITHUB_ENV

      # 8. 获取项目依赖
      - name: Get Flutter dependencies
        run: dart pub get

      # 8.1 分析代码 (设置出错不中断，防止因代码风格问题停止打包)
      - name: Analyze Dart code
        run: flutter analyze
        continue-on-error: true

      # 9. 初始化并编译 Android 核心 (关键步骤)
      - name: Build Android Core
        run: dart ./setup.dart android

      # 10. 构建 Release APK (添加了 id: build 修复引用错误)
      - name: Build Release APK
        id: build
        run: |
          flutter build apk --release --verbose 2>&1 | tee build.log
        continue-on-error: true

      # 10.1 上传构建日志 (方便排错)
      - name: Upload build log
        if: steps.build.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 3

      # 10.2 检查构建结果 (修复了逻辑)
      - name: Check build result
        if: steps.build.outcome == 'failure'
        run: |
          echo "Build failed! analyzing errors..."
          grep -C 5 "error" build.log || echo "No explicit error found in grep"
          exit 1

      # 11. 上传 APK 文件
      - name: Upload APK
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: flclash-android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
